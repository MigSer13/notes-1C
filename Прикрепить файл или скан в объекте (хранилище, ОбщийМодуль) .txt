
#Область Работа_с_сохранением_или_открытием_прикрепленного_файла_КЛИЕНТ

&НаКлиенте
Процедура ОткрытиеПрикрепленногоФайла(СтандартнаяОбработка, СсылкаНаПрикрепленныйФайл) Экспорт
	СтандартнаяОбработка = Ложь;
	Если СсылкаНаПрикрепленныйФайл.Пустая() Тогда	
		Возврат;
	КонецЕсли;  
	
  	ДанныеФайла = цкаСХ_ОбщийМодуль.ПолучитьДанныеФайлаСервер(СсылкаНаПрикрепленныйФайл);
	ИмяВременногоФайла = КаталогВременныхФайлов()+ ДанныеФайла.ИмяФайлаАктаСписания;
  	ДанныеФайла.ДвоичныеДанные.Записать(ИмяВременногоФайла);
	Попытка
		ЗапуститьПриложение(ИмяВременногоФайла);
	Исключение
		Сообщить("Ошибка при открытии файла: " + ОписаниеОшибки(), СтатусСообщения.Важное);
		Возврат;
	КонецПопытки;
КонецПроцедуры

&НаКлиенте
Процедура НачалоВыбораПрикрепленногоФайла(СтандартнаяОбработка, Форма) Экспорт
	СтандартнаяОбработка = Ложь;
	СсылкаНаПрикрепленныйФайл = Форма.Объект.цка_СсылкаНаПрикрепленныйФайл;
	
	// Выбрать файл на диске
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);	
	ДиалогВыбораФайла.Фильтр                  = "Все файлы|*.*";
	ДиалогВыбораФайла.Заголовок               = "Выберите файл";
	ДиалогВыбораФайла.ПредварительныйПросмотр = Ложь;
	ДиалогВыбораФайла.Расширение              = "*";
	ДиалогВыбораФайла.ИндексФильтра           = 0;
		
	// Присвоить двоичные данные реквизиту Хранилище
	Если ДиалогВыбораФайла.Выбрать() Тогда
			ДанныеВыбораФайла = Новый Структура;
			ДанныеВыбораФайла.Вставить("ПолноеИмяФайла" ,ДиалогВыбораФайла.ПолноеИмяФайла);
			ДанныеВыбораФайла.Вставить("Каталог" ,ДиалогВыбораФайла.Каталог);
			ДанныеВыбораФайла.Вставить("Форма", Форма);

			Если НЕ СсылкаНаПрикрепленныйФайл.Пустая() Тогда
				ПоказатьВопрос(Новый ОписаниеОповещения("ВопросУдаленияПрикрепленногоФайла", ЭтотОбъект, ДанныеВыбораФайла), 
							"Заменить уже имеющийся файл на выбранный?", РежимДиалогаВопрос.ДаНет);	
			Иначе
				СохранитьФайлВБазу(ДанныеВыбораФайла);
			КонецЕсли;					
	Иначе
			Возврат;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте 
Процедура ВопросУдаленияПрикрепленногоФайла(Результат, ДанныеВыбораФайла) Экспорт
	Если Результат = КодВозвратаДиалога.Нет Тогда	
		Возврат;
	КонецЕсли;
	СсылкаНаПрикрепленныйФайл = ДанныеВыбораФайла.Форма.Объект.цка_СсылкаНаПрикрепленныйФайл;
	
	цкаСХ_ОбщийМодуль.УдалитьПрошлыйФайлСервер(СсылкаНаПрикрепленныйФайл);
	СохранитьФайлВБазу(ДанныеВыбораФайла);	
КонецПроцедуры

&НаКлиенте 
Процедура СохранитьФайлВБазу(ДанныеВыбораФайла)
	ИмяФайла = СтрЗаменить(ДанныеВыбораФайла.ПолноеИмяФайла, ДанныеВыбораФайла.Каталог, "");
	ВнешнийФайл = Новый ДвоичныеДанные(ДанныеВыбораФайла.ПолноеИмяФайла);	
	ДанныеВыбораФайла.Форма.Объект.цка_СсылкаНаПрикрепленныйФайл = цкаСХ_ОбщийМодуль.ПолучитьНовуюСсылкуНаФайлСервер(ИмяФайла, ВнешнийФайл);	
КонецПроцедуры
 
#КонецОбласти 



#Область Работа_с_сохранением_или_открытием_прикрепленного_файла_СЕРВЕР

Функция ПолучитьДанныеФайлаСервер(СсылкаНаПрикрепленныйФайл) Экспорт
	ДанныеФайла = Новый Структура;
	ДанныеФайла.Вставить("ДвоичныеДанные", СсылкаНаПрикрепленныйФайл.Файл.Получить()); 
	ДанныеФайла.Вставить("ИмяФайлаАктаСписания", СсылкаНаПрикрепленныйФайл.ПолноеИмяФайла);
    Возврат ДанныеФайла;	   
КонецФункции

Функция ПолучитьНовуюСсылкуНаФайлСервер(ИмяФайлаАктаСписания, ВнешнийФайл)Экспорт
	НовыйОбъектФайл = Справочники.цка_ХранилищеФайлов.СоздатьЭлемент();		
	НовыйОбъектФайл.Файл = Новый ХранилищеЗначения(ВнешнийФайл);
	НовыйОбъектФайл.ПолноеИмяФайла = ИмяФайлаАктаСписания;
	НовыйОбъектФайл.Наименование = ИмяФайлаАктаСписания;
	НовыйОбъектФайл.Записать(); 
	Возврат НовыйОбъектФайл.Ссылка;
КонецФункции  

Процедура УдалитьПрошлыйФайлСервер(СсылкаНаФайл)Экспорт
	ОбъектФайл = СсылкаНаФайл.ПолучитьОбъект();
	ОбъектФайл.Удалить();
КонецПроцедуры
 
#КонецОбласти 